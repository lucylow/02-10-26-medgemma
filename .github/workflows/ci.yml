# CI: tests and linting for PediScreen/MedGemma
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install backend deps
        run: |
          cd backend && pip install -r requirements.txt -r requirements-dev.txt
      - name: Run backend tests
        run: |
          cd backend && pytest -q --tb=short
        env:
          API_KEY: test-key
          MOCK_FALLBACK: "true"

  root-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps (root / pedi_screen)
        run: |
          pip install pytest pytest-asyncio
          pip install pydantic
      - name: Run root tests (model loader, inference fallback, circuit)
        run: |
          export PYTHONPATH="${GITHUB_WORKSPACE}:${GITHUB_WORKSPACE}/backend"
          pytest tests/test_model_loader.py tests/test_inference_fallback.py tests/test_circuit_breaker.py -q --tb=short
        continue-on-error: true

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Ruff
        run: |
          pip install ruff
          ruff check backend/app configs utils monitoring pedi_screen/medgemma_core pedi_screen/monitoring --ignore E501
        continue-on-error: true
